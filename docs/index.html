<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Get Started With Developing In Ethereum</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Get Started With Developing In Ethereum (c) Bok Consulting Pty Ltd 2023" /4
    <meta name="author" content="BokkyPooBah" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@BokkyPooBah" />
    <meta name="twitter:creator" content="@BokkyPooBah" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue-icons.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/app.css" />
    <script src="js/vue.js"></script>
    <script src="js/bootstrap-vue.min.js"></script>
    <script src="js/bootstrap-vue-icons.min.js"></script>
    <script src="js/ethers-5.7.umd.min.js" type="application/javascript"></script>
    <script src="js/moment.min.js"></script>
    <script src="globals.js"></script>
    <script src="customNames.js"></script>
    <script src="deploymentData.js"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="mask-icon" href="images/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="images/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="images/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body>
    <div id="app">
      <b-container fluid class="m-0 p-0">
        <b-navbar toggleable="sm" variant="light" class="mx-1 my-0 p-0">
          <b-navbar-brand to="https://bokkypoobah.github.io/GetStartedWithDevelopingInEthereum/" variant="primary">
            <b-avatar rounded variant="light" size="3.0rem" src="images/ZombieBaby_004_transparentbg_zoomed.png" v-b-popover.hover.ds500="'gm'" class="ml-0"></b-avatar>
            <em v-b-popover.hover.ds500="'gm gm gm'">Get Started With Developing In Ethereum</em>
          </b-navbar-brand>
          <b-navbar-nav class="ml-auto">
            <b-nav-item size="sm" @click="settings.tabIndex = 0; saveSettings();" :active="settings.tabIndex == 0" active-class="active" v-b-popover.hover.ds500="'ERC-20 Fungible Tokens'">ERC-20</b-nav-item>
            <b-nav-item size="sm" @click="settings.tabIndex = 1; saveSettings();" :active="settings.tabIndex == 1" active-class="active" v-b-popover.hover.ds500="'ERC-721 Non-Fungible Tokens'">ERC-721</b-nav-item>
            <b-nav-item size="sm" @click="settings.tabIndex = 2; saveSettings();" :active="settings.tabIndex == 2" active-class="active" v-b-popover.hover.ds500="'ERC-1155 Non-Fungible Tokens'">ERC-1155</b-nav-item>
            <b-button size="sm" variant="outline-primary" class="ml-1" @click="connectToWeb3(); processNewBlock(0);" v-b-popover.hover.ds500="'Click to update wallet'">{{ coinbase && (coinbase.substring(0, 6) + '...' + coinbase.slice(-4)) || 'Connect' }}</b-button>
          </b-navbar-nav>
        </b-navbar>

        <b-card no-body class="p-0 mt-0" style="min-height: 666px;">
          <b-alert v-if="chainId && chainId != 11155111" size="sm" dismissible variant="warning" show class="m-1 my-0">
            Warning: This dapp is for use on the Ethereum Sepolia testnet
          </b-alert>
          <b-card class="m-2 p-1" header-class="warningheader" header="Welcome" v-if="!coinbase">
            <b-card-text>
              Please install the MetaMask extension and connect to the Ethereum Mainnet or an EVM compatible chain. Then refresh this page, and click the [Connect] button on the top right.
            </b-card-text>
          </b-card>

          <b-card class="m-0 p-0 border-0" body-class="m-1 p-0">
            <b-card v-if="settings.tabIndex == 0" header="ERC-20" class="m-0 p-0">
              <b-form-group label="contract:" label-for="erc20-contract" label-size="sm" label-cols-sm="2" label-align-sm="right" description="e.g., '0x7439E9Bb6D8a84dd3A23fe621A30F95403F87fB9' for WEENUS on Sepolia" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" id="erc20-contract" v-model="settings.erc20.contract" @change="saveSettings" class="w-50"></b-form-input>
              </b-form-group>
              <b-form-group label="" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-button size="sm" @click="retrieveERC20" variant="primary">Retrieve</b-button>
              </b-form-group>
              <b-form-group label="symbol:" label-for="erc20-symbol" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="erc20-symbol" :value="erc20.symbol" class="w-25"></b-form-input>
              </b-form-group>
              <b-form-group label="name:" label-for="erc20-name" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="erc20-name" :value="erc20.name" class="w-25"></b-form-input>
              </b-form-group>
              <b-form-group label="decimals:" label-for="erc20-decimals" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="erc20-decimals" :value="erc20.decimals" class="w-25"></b-form-input>
              </b-form-group>
              <b-form-group label="totalSupply:" label-for="erc20-totalsupply" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-row>
                  <b-col cols="4">
                    <b-form-input type="text" size="sm" readonly id="erc20-totalsupply" :value="formatNumber(erc20.totalSupply)"></b-form-input>
                  </b-col>
                  <b-col cols="4">
                    <b-form-input type="text" size="sm" readonly id="erc20-totalsupplydecimals" :value="formatDecimals(erc20.totalSupply, erc20.decimals)"></b-form-input>
                  </b-col>
                </b-row>
              </b-form-group>
              <b-form-group label="events:" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-2">
                  <b-table small fixed striped :items="erc20.events" head-variant="light">
                  </b-table>
                </font>
                <!-- <b-table small fixed striped sticky-header="200px" :fields="accountsFilterFields" :items="getAllAccounts" head-variant="light">
                  <template #cell(select)="data">
                    <b-form-checkbox size="sm" :checked="(settings.filters['accounts'] && settings.filters['accounts'][data.item.account]) ? 1 : 0" value="1" @change="filterChanged('accounts', data.item.account)"></b-form-checkbox>
                  </template>
                  <template #cell(account)="data">
                    {{ ensOrAccount(data.item.account, 20) }}
                  </template>
                </b-table> -->
              </b-form-group>

            </b-card>
          </b-card>
            <b-card-text class="m-0 p-0">
              <!-- :INFO -->
              <b-card v-if="settings.showInfo || coinbase == null" no-body class="my-1 p-1">
                <b-card-body class="mt-1 p-1">
                  <h4>Welcome</h4>
                  TODO

                  <h5 class="mt-4">How This Works</h5>
                  <ul>
                    <li>This tool scans for <b-link href="https://eips.ethereum.org/EIPS/eip-20#events" target="_blank">ERC-20</b-link>, <b-link href="https://eips.ethereum.org/EIPS/eip-721#specification" target="_blank">ERC-721</b-link> and <b-link href="https://eips.ethereum.org/EIPS/eip-1155#specification" target="_blank">ERC-1155</b-link> <b>Approval</b> and <b>ApprovalForAll</b> log events from the owner's account. This is done using the <b-link href="https://docs.ethers.org/v5/api/providers/provider/#Provider-getLogs" target="_blank">getLogs(filter)</b-link> web3 call</li>
                    <li>These event logs are then processed to determine the approval states for the various ERC-20, ERC-721 and ERC-1155 contracts</li>
                    <li>The latest ERC-20 approval amounts are retrieved using the ERC-20 <b>allowance(...)</b> function</li>
                  </ul>

                  <h5 class="mt-3">Requirements</h5>
                  <ul>
                    <li>This dapp runs in web3 enabled desktop browsers connected to the Ethereum mainnet, and should work with other Ethereum-Virtual-Machine compatible chains</li>
                  </ul>

                  <h5 class="mt-3">References</h5>
                  <ul>
                    <li>Dapp: <b-link href="https://bokkypoobah.github.io/GetStartedWithDevelopingInEthereum/" target="_blank">https://bokkypoobah.github.io/GetStartedWithDevelopingInEthereum/</b-link></li>
                    <li>GitHub: <b-link href="https://github.com/bokkypoobah/GetStartedWithDevelopingInEthereum" target="_blank">https://github.com/bokkypoobah/GetStartedWithDevelopingInEthereum</b-link></li>
                    <li>Main Dapp Source Code: <b-link href="https://github.com/bokkypoobah/GetStartedWithDevelopingInEthereum/blob/main/docs/index.html" target="_blank">https://github.com/bokkypoobah/GetStartedWithDevelopingInEthereum/blob/main/docs/index.html</b-link></li>
                  </ul>

                  <h5 class="mt-3">Running Locally</h5>
                  <ul>
                    <li>In a folder on your computer, <b>git clone <b-link href="https://github.com/bokkypoobah/GetStartedWithDevelopingInEthereum" target="_blank">https://github.com/bokkypoobah/GetStartedWithDevelopingInEthereum</b-link></b></li>
                    <li>Run a tool like <b-link href="https://www.npmjs.com/package/anywhere" target="_blank">anywhere</b-link> in the <b>./docs</b> subdirectory of the folder created above</li>
                  </ul>

                  <h5 class="mt-3">Design</h5>
                  <ul>
                    <li>This dapp is designed to have minimal external dependencies - all code is statically served from GitHub</li>
                    <li>No backend servers are necessary, only a web3 connection</li>
                  </ul>

                  <h5 class="mt-3">Warning</h5>
                  <ul>
                    <li>This is experimental unaudited software. Please check your transaction data carefully when updating your approvals!</li>
                  </ul>

                  <h5 class="mt-3">Troubleshooting</h5>
                  <ul>
                    <li>If this dapp is not receiving the latest Mainnet data, reset your MetaMask web3 connection using <b>Settings</b> -> <b>Advanced</b> -> <b>Clear activity and nonce data</b></li>
                    <li>Reset this dapp data by removing LocalStorage entries with the keys beginning with <b>approval</b></li>
                  </ul>
                </b-card-body>
              </b-card>

            </b-card-text>
          </b-card>
        </b-card>

        <b-card no-header body-class="m-0 p-0" class="m-0 p-0 border-0">
          <div class="d-flex flex-wrap m-0 p-0">
            <div class="ml-0 mt-1 pl-1">
              <font v-if="connected" size="-2">
                <b-link v-if="coinbase" :href="'https://sepolia.etherscan.io/address/' + coinbase" v-b-popover.hover.ds500="'Coinbase'" target="_blank">
                  {{ coinbase && (coinbase.substring(0, 6) + '...' + coinbase.slice(-4)) || 'Connect' }}
                </b-link>
                <b-link v-if="chainId" :href="'https://sepolia.etherscan.io/'" v-b-popover.hover.ds500="'Network'" target="_blank">
                  {{ chainId == '11155111' ? 'Sepolia' : 'Unsupported' }}
                </b-link>
                <b-link v-if="blockNumber" :href="'https://sepolia.etherscan.io/block/' + blockNumber" v-b-popover.hover.ds500="'Latest block'" target="_blank">
                  {{ '#' + commify0(blockNumber) }}
                </b-link>
                <b-link v-if="blockNumber" :href="'https://sepolia.etherscan.io/block/' + blockNumber" v-b-popover.hover.ds500="formatTimestamp(timestamp)" target="_blank">
                  {{ formatTimeDiff(timestamp) }}
                </b-link>
              </font>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div class="mt-0 pl-1 pr-1">
              gm, and enjoy! <i>GetStartedWithDevelopingInEthereum</i> &copy; Bok Consulting Pty Ltd 2024
            </div>
          </div>
        </b-card>
      </b-container>
    </div>

    <script>
      window.app = new Vue({
        el: '#app',
        // --- DATA ---
        data: {
          connected: false,
          chainId: null,
          coinbase: null,
          blockNumber: null,
          timestamp: null,
          forceRefresh: 0,

          settings: {
            tabIndex: 0,

            erc20: {
              contract: null,
            },
            erc721: {
              contract: null,
            },
            erc1155: {
              contract: null,
            },
            version: 0,
          },
          erc20: {
            symbol: null,
            name: null,
            decimals: null,
            totalSupply: null,
            balances: {},
            allowances: {},
            events: [],
          },
        },

        // --- COMPUTED ---
        computed: {
        },

        // --- METHODS ---
        methods: {
          async retrieveERC20() {
            console.log(moment().format("HH:mm:ss") + " retrieveERC20 BEGIN - settings.erc20: " + JSON.stringify(this.settings.erc20, null, 2));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const contract = new ethers.Contract(this.settings.erc20.contract, ERC20ABI, provider);
            const block = await provider.getBlock("latest");
            const blockNumber = parseInt(block.number);
            const timestamp = parseInt(block.timestamp);

            const symbol = await contract.symbol();
            Vue.set(this.erc20, 'symbol', symbol);
            const name = await contract.name();
            Vue.set(this.erc20, 'name', name);
            const decimals = await contract.decimals();
            Vue.set(this.erc20, 'decimals', decimals.toString());
            const totalSupply = await contract.totalSupply();
            Vue.set(this.erc20, 'totalSupply', totalSupply.toString());

            try {
              const filter = {
                address: this.settings.erc20.contract,
                fromBlock: blockNumber - 10000,
                toBlock: blockNumber,
                topics: [
                  ethers.utils.id("Transfer(address,address,uint256)"),
                  null,
                  null,
                ],
              };
              console.log(moment().format("HH:mm:ss") + " retrieveERC20 - filter: " + JSON.stringify(filter, null, 2));
              const eventLogs = await provider.getLogs(filter);
              const events = [];
              for (const event of eventLogs) {
                console.log(moment().format("HH:mm:ss") + " retrieveERC20 - event: " + JSON.stringify(event, null, 2));
                const log = contract.interface.parseLog(event);
                console.log(moment().format("HH:mm:ss") + " retrieveERC20 - log: " + JSON.stringify(log, null, 2));
                if (log.eventFragment.name == "Transfer") {
                  console.log("transfer");
                  const [ from, to, tokens ] = log.args;
                    events.push({
                      blockNumber: event.blockNumber,
                      logIndex: parseInt(event.logIndex),
                      // txIndex: parseInt(log.transactionIndex),
                      // txHash: log.transactionHash,
                      // contract,
                      // name: logData.name,
                      // registrant: ethers.utils.getAddress(logData.args[0]),
                      // schemeId,
                      // stealthMetaAddress: ethers.utils.toUtf8String(logData.args[2]),
                      // mine: false,
                      // confirmations: parameter.blockNumber - log.blockNumber,
                      // timestamp: null,
                      // tx: null,



                    from,
                    to,
                    tokens: tokens.toString(),
                  });
                }
              }
              Vue.set(this.erc20, 'events', events);
            } catch (e) {
              console.log(moment().format("HH:mm:ss") + " retrieveERC20 ERROR: " + e.message);
            }



            console.log(moment().format("HH:mm:ss") + " retrieveERC20 END - erc20: " + JSON.stringify(this.erc20, null, 2));
          },

          saveSettings() {
            console.log(moment().format("HH:mm:ss") + " saveSettings: " + JSON.stringify(this.settings, null, 2));
            localStorage.getStartedWithDevelopingInEthereumSettings = JSON.stringify(this.settings);
          },
          async processNewBlock(blockNumber) {
            console.log(moment().format("HH:mm:ss") + " processNewBlock[" + this.chainId + "] #" + this.commify0(blockNumber) + ", latest #" + this.commify0(this.blockNumber) + " @ " + moment.unix(this.timestamp).format("YYYY-MM-DD HH:mm:ss") + " " + moment.unix(this.timestamp).fromNow());
          },
          commify0(n) {
            if (n != null) {
              return Number(n).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            return null;
          },
          formatETH(e, precision = 9) {
            try {
              if (precision == 0) {
                return e ? ethers.utils.formatEther(e) : null;
              } else {
                return e ? parseFloat(ethers.utils.formatEther(e)).toFixed(precision) : null;
              }
            } catch (err) {
            }
            return e.toFixed(precision);
          },
          formatNumber(e) {
            return e ? e.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : null;
          },
          formatDecimals(e, decimals = 18) {
            return e ? ethers.utils.formatUnits(e, decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : null;
          },
          formatTimestamp(ts) {
            if (ts != null) {
              if (this.settings.reportingDateTime == 1) {
                return moment.unix(ts).utc().format("YYYY-MM-DD HH:mm:ss");
              } else {
                return moment.unix(ts).format("YYYY-MM-DD HH:mm:ss");
              }
            }
            return null;
          },
          formatTimeDiff(unixtime) {
            if (!unixtime) {
              return "";
            } else {
              return moment.unix(unixtime).fromNow();
            }
          },
          copyToClipboard(str) {
            navigator.clipboard.writeText(str);
          },
          async connectToWeb3() {
            if (!window.ethereum) {
              this.connected = false;
            } else {
              try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                this.connected = window.ethereum.isConnected();
              } catch (e) {
                console.log("window.ethereum.request error: " + e.message);
                this.connected = false;
              }
            }
            if (!this.connected) {
              alert("Please use the https://metamask.io addon with Firefox, Chromium, Opera or Chrome, or any other other web3 browser, for web3 data retrieval. And refresh!");
            } else {
              const t = this;
              function handleChainChanged(_chainId) {
                t.chainId = _chainId;
                console.log(moment().format("HH:mm:ss") + " connectToWeb3 - handleChainChanged - this.chainId: " + t.chainId);
                alert('Ethereum chain has changed - reloading this page.')
                window.location.reload();
              }
              window.ethereum.on('chainChanged', handleChainChanged);
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              async function handleAccountsChanged(accounts) {
                const signer = provider.getSigner();
                t.coinbase = await signer.getAddress();
                console.log(moment().format("HH:mm:ss") + " connectToWeb3 - handleAccountsChanged: " + t.coinbase);
              }
              window.ethereum.on('accountsChanged', handleAccountsChanged);
              async function handleNewBlock(blockNumber) {
                if (!t.blockNumber || blockNumber > t.blockNumber) {
                  const block = await provider.getBlock("latest");
                  t.blockNumber = block.number;
                  t.timestamp = block.timestamp;
                  await t.processNewBlock(blockNumber);
                }
              }
              provider.on("block", handleNewBlock);
              const signer = provider.getSigner();
              this.coinbase = await signer.getAddress();
              const network = await provider.getNetwork();
              this.chainId = network.chainId;
              console.log(moment().format("HH:mm:ss") + " connectToWeb3[" + this.chainId + "]");
            }
          },
        },

        // --- MOUNTED ---
        mounted() {
          (async() => {
            await this.connectToWeb3();
          })();
          if ('getStartedWithDevelopingInEthereumChainId' in localStorage) {
            this.chainId = localStorage.getStartedWithDevelopingInEthereumChainId;
          }
          if ('getStartedWithDevelopingInEthereumCoinbase' in localStorage) {
            this.coinbase = localStorage.getStartedWithDevelopingInEthereumCoinbase;
          }
          if ('getStartedWithDevelopingInEthereumSettings' in localStorage) {
            const tempSettings = JSON.parse(localStorage.getStartedWithDevelopingInEthereumSettings);
            if ('version' in tempSettings && tempSettings.version == this.settings.version) {
              this.settings = tempSettings;
            }
          }
        },
      })
    </script>
  </body>
</html>
